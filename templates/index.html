<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Path Library - Jot Potato</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'brand': {
                            DEFAULT: '#1F2937',
                            50: '#F3F4F6',
                            100: '#E5E7EB',
                            200: '#D1D5DB',
                            500: '#1F2937',
                            600: '#1a2332',
                            700: '#151c29',
                        }
                    }
                },
            },
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
{% verbatim %}
    <div id="app" v-cloak class="flex min-h-screen">
        <!-- Sidebar - Hidden on mobile -->
        <aside class="hidden md:flex fixed left-0 top-0 h-full w-16 bg-gray-800 flex-col items-center py-4 z-50">
            <!-- App Label -->
            <div class="text-xs text-gray-400 mb-4 tracking-wide">Path library</div>

            <!-- Main Navigation -->
            <nav class="flex flex-col items-center gap-2 flex-1">
                <!-- Potato (Home/Paths) - Active -->
                <button class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center hover:bg-blue-200 transition" title="Paths Library">
                    <svg class="w-6 h-6 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                        <ellipse cx="12" cy="13" rx="8" ry="9" fill="currentColor" opacity="0.3"/>
                        <ellipse cx="12" cy="12" rx="7" ry="8" fill="currentColor"/>
                        <circle cx="9" cy="10" r="1" fill="white"/>
                        <circle cx="14" cy="9" r="0.8" fill="white"/>
                        <circle cx="11" cy="14" r="0.6" fill="white"/>
                    </svg>
                </button>

                <!-- Analytics -->
                <button class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-700 transition text-gray-400 hover:text-white" title="Analytics">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </button>

                <!-- Sync/Refresh -->
                <button @click="fetchPaths" class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-700 transition text-gray-400 hover:text-white" title="Refresh">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>

                <!-- Messages -->
                <button class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-700 transition text-gray-400 hover:text-white" title="Messages">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </button>
            </nav>

            <!-- Bottom Navigation -->
            <div class="flex flex-col items-center gap-2 mt-auto">
                <!-- Notifications -->
                <button class="w-10 h-10 rounded-xl flex items-center justify-center hover:bg-gray-700 transition text-gray-400 hover:text-white" title="Notifications">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 md:ml-16">
            <!-- Top Navigation Bar -->
            <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
                <div class="px-4 md:px-6 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-2 md:gap-3">
                        <!-- Mobile Menu Button -->
                        <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden w-8 h-8 rounded-lg flex items-center justify-center hover:bg-gray-100">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <!-- Potato Icon -->
                        <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                                <ellipse cx="12" cy="12" rx="7" ry="8" fill="currentColor"/>
                                <circle cx="9" cy="10" r="1" fill="white"/>
                                <circle cx="14" cy="9" r="0.8" fill="white"/>
                                <circle cx="11" cy="14" r="0.6" fill="white"/>
                            </svg>
                        </div>
                        <!-- Breadcrumb -->
                        <nav class="flex items-center text-sm">
                            <span class="hidden sm:inline text-gray-900 font-medium">Work Area</span>
                            <span class="hidden sm:inline mx-2 text-gray-400">¬ª</span>
                            <button class="flex items-center gap-1 text-gray-900 font-medium hover:text-gray-600">
                                Paths Library
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </header>

            <!-- Mobile Menu Dropdown -->
            <div v-if="mobileMenuOpen" class="md:hidden bg-gray-800 border-b border-gray-700">
                <div class="flex items-center justify-around py-3">
                    <button class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                            <ellipse cx="12" cy="12" rx="7" ry="8" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </button>
                    <button @click="fetchPaths" class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                    <button class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                    </button>
                </div>
            </div>

            <main class="px-4 md:px-6 py-4 md:py-6">
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6 md:mb-8">
                <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                    <div class="text-2xl font-bold text-gray-900">{{ stats.total }}</div>
                    <div class="text-sm text-gray-500">Total Paths</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-green-100">
                    <div class="text-2xl font-bold text-green-600">{{ stats.active }}</div>
                    <div class="text-sm text-gray-500">Active</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-yellow-100">
                    <div class="text-2xl font-bold text-yellow-600">{{ stats.on_hold }}</div>
                    <div class="text-sm text-gray-500">On Hold</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-sm border border-blue-100">
                    <div class="text-2xl font-bold text-blue-600">{{ stats.completed }}</div>
                    <div class="text-sm text-gray-500">Completed</div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-6">
                <div class="mb-4">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                        <input
                            v-model="searchQuery"
                            @input="debouncedSearch"
                            type="text"
                            placeholder="Search paths..."
                            class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent"
                        />
                        <button v-if="searchQuery" @click="clearSearch" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button
                        v-for="filter in filters"
                        :key="filter.value"
                        @click="currentFilter = filter.value"
                        :class="[
                            'px-4 py-2 rounded-lg text-sm font-medium transition',
                            currentFilter === filter.value ? 'bg-brand-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        ]"
                    >{{ filter.label }}</button>
                </div>
            </div>

            <!-- Path List -->
            <div class="space-y-3" v-if="!selectedPath">
                <div
                    v-for="path in filteredPaths"
                    :key="path.id"
                    @click="selectPath(path.id)"
                    class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 hover:shadow-md hover:border-brand-200 cursor-pointer transition"
                >
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ path.title }}</h3>
                    <p v-if="path.project_summary" class="text-gray-500 mb-4 line-clamp-2">{{ path.project_summary }}</p>
                    <p v-else class="text-gray-400 mb-4 line-clamp-2">No description</p>

                    <div class="flex items-center text-sm text-gray-500">
                        <span :class="statusBadgeClass(path.status)">{{ formatStatus(path.status) }}</span>
                        <span class="mx-3 text-gray-300">|</span>
                        <span v-if="path.duration_days">{{ path.duration_days }} days</span>
                        <span v-else>‚Äî</span>
                        <span class="mx-3 text-gray-300">|</span>
                        <span v-if="path.status === 'completed' && path.completed_at">{{ formatRelativeTime(path.completed_at) }}</span>
                        <span v-else-if="path.status === 'on_hold' && path.paused_at">{{ formatRelativeTime(path.paused_at) }}</span>
                        <span v-else>{{ formatRelativeTime(path.updated_at) }}</span>
                    </div>
                </div>
                <div v-if="filteredPaths.length === 0" class="text-center py-12 text-gray-500">No paths found.</div>
            </div>

            <!-- Path Detail View -->
            <div v-if="selectedPath" class="bg-white rounded-xl shadow-sm border border-gray-100">
                <!-- Back Button -->
                <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                    <button @click="selectedPath = null" class="flex items-center gap-2 text-gray-600 hover:text-gray-900">‚Üê Back to Path Library</button>
                    <div class="flex items-center gap-3">
                        <button v-if="selectedPath.status === 'on_hold'" @click="updatePathStatus('active')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-medium">Reopen this path</button>
                    </div>
                </div>

                <!-- Path Header -->
                <div class="p-4 md:p-6 border-b border-gray-100">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <span :class="statusBadgeClass(selectedPath.status)">{{ formatStatus(selectedPath.status) }}</span>
                                <span :class="priorityBadgeClass(selectedPath.priority)">{{ selectedPath.priority }}</span>
                            </div>
                            <h2 class="text-xl md:text-2xl font-bold text-gray-900">{{ selectedPath.title }}</h2>
                            <p class="text-gray-600 mt-2 text-sm md:text-base" v-if="selectedPath.goal_statement">{{ selectedPath.goal_statement }}</p>
                        </div>
                        <div class="text-left sm:text-right flex-shrink-0">
                            <div class="text-3xl md:text-4xl font-bold text-brand-500">{{ selectedPath.progress_percentage }}%</div>
                            <div class="text-sm text-gray-500">complete</div>
                        </div>
                    </div>

                    <!-- Metadata Row -->
                    <div class="flex flex-wrap items-center gap-4 md:gap-6 mt-4 pt-4 border-t border-gray-100 text-sm">
                        <div v-if="selectedPath.status === 'on_hold' && selectedPath.paused_at" class="flex items-center gap-2">
                            <span class="text-gray-400">üìÖ</span>
                            <div><div class="text-xs text-gray-400">Paused On</div><div class="font-medium text-gray-900">{{ formatDateLong(selectedPath.paused_at) }}</div></div>
                        </div>
                        <div v-if="selectedPath.status === 'completed' && selectedPath.completed_at" class="flex items-center gap-2">
                            <span class="text-gray-400">üìÖ</span>
                            <div><div class="text-xs text-gray-400">Completed On</div><div class="font-medium text-gray-900">{{ formatDateLong(selectedPath.completed_at) }}</div></div>
                        </div>
                        <div v-if="selectedPath.duration_days" class="flex items-center gap-2">
                            <span class="text-gray-400">‚è±</span>
                            <div><div class="text-xs text-gray-400">Duration</div><div class="font-medium text-gray-900">{{ selectedPath.duration_days }} days</div></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400">üë•</span>
                            <div><div class="text-xs text-gray-400">Team Size</div><div class="font-medium text-gray-900">{{ selectedPath.team_size || 1 }} members</div></div>
                        </div>
                    </div>
                </div>

                <!-- Project Summary Section -->
                <div v-if="selectedPath.project_summary || selectedPath.status === 'on_hold' || selectedPath.status === 'completed'" class="p-4 md:p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between cursor-pointer" @click="summaryExpanded = !summaryExpanded">
                        <h3 class="font-semibold text-gray-900">Project Summary</h3>
                        <span class="text-gray-400">{{ summaryExpanded ? '‚ñº' : '‚ñ∂' }}</span>
                    </div>
                    <div v-show="summaryExpanded" class="mt-4 space-y-4">
                        <p v-if="selectedPath.project_summary" class="text-gray-600">{{ selectedPath.project_summary }}</p>

                        <!-- On Hold Info -->
                        <div v-if="selectedPath.status === 'on_hold'" class="space-y-4">
                            <div v-if="selectedPath.on_hold_reason" class="bg-yellow-50 rounded-lg p-4 border border-yellow-100">
                                <div class="flex items-center gap-2 mb-2"><span class="text-yellow-500">üí°</span><h4 class="font-semibold text-gray-900">Why it's on hold</h4></div>
                                <p class="text-gray-700">{{ selectedPath.on_hold_reason }}</p>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div v-if="selectedPath.what_was_started" class="bg-green-50 rounded-lg p-4 border border-green-100">
                                    <div class="flex items-center gap-2 mb-2"><span class="text-green-500">‚úì</span><h4 class="font-semibold text-gray-900">What you started to solve</h4></div>
                                    <p class="text-gray-700">{{ selectedPath.what_was_started }}</p>
                                </div>
                                <div v-if="selectedPath.on_hold_issues_faced" class="bg-red-50 rounded-lg p-4 border border-red-100">
                                    <div class="flex items-center gap-2 mb-2"><span class="text-red-500">‚ö†</span><h4 class="font-semibold text-gray-900">Issues you faced</h4></div>
                                    <p class="text-gray-700">{{ selectedPath.on_hold_issues_faced }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Completed Info -->
                        <div v-if="selectedPath.status === 'completed'" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div v-if="selectedPath.what_was_solved?.length" class="bg-green-50 rounded-lg p-4 border border-green-100">
                                    <div class="flex items-center gap-2 mb-2"><span class="text-green-500">‚úì</span><h4 class="font-semibold text-gray-900">What you solved</h4></div>
                                    <ul class="space-y-1"><li v-for="item in selectedPath.what_was_solved" class="text-gray-700 flex items-start gap-2"><span class="text-green-400 mt-1">‚Ä¢</span><span>{{ item }}</span></li></ul>
                                </div>
                                <div v-if="selectedPath.completed_issues_faced?.length" class="bg-red-50 rounded-lg p-4 border border-red-100">
                                    <div class="flex items-center gap-2 mb-2"><span class="text-red-500">‚ö†</span><h4 class="font-semibold text-gray-900">Issues you faced</h4></div>
                                    <ul class="space-y-1"><li v-for="item in selectedPath.completed_issues_faced" class="text-gray-700 flex items-start gap-2"><span class="text-red-400 mt-1">‚Ä¢</span><span>{{ item }}</span></li></ul>
                                </div>
                            </div>
                            <div v-if="selectedPath.key_learnings?.length" class="bg-purple-50 rounded-lg p-4 border border-purple-100">
                                <div class="flex items-center gap-2 mb-2"><span class="text-purple-500">üí°</span><h4 class="font-semibold text-gray-900">Key Learnings & Insights</h4></div>
                                <ul class="space-y-1"><li v-for="item in selectedPath.key_learnings" class="text-gray-700 flex items-start gap-2"><span class="text-purple-400 mt-1">‚Ä¢</span><span>{{ item }}</span></li></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Path Journey (Issue -> Root Cause -> Initiative) -->
                <div class="p-4 md:p-6 border-b border-gray-100 bg-gray-50">
                    <h3 class="font-semibold text-gray-900 mb-4">Path Journey</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                        <div class="bg-white rounded-lg p-4 border border-red-100">
                            <div class="text-xs font-medium text-red-600 mb-1">üìã ISSUE</div>
                            <div class="font-semibold text-gray-900">{{ selectedPath.issue?.title }}</div>
                            <div class="text-sm text-gray-500 mt-1">{{ selectedPath.issue?.description }}</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-yellow-100">
                            <div class="text-xs font-medium text-yellow-600 mb-1">üîç ROOT CAUSE</div>
                            <div class="font-semibold text-gray-900">{{ selectedPath.root_cause?.title }}</div>
                            <div class="text-sm text-gray-500 mt-1">{{ selectedPath.root_cause?.description }}</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 border border-green-100">
                            <div class="text-xs font-medium text-green-600 mb-1">üí° INITIATIVE</div>
                            <div class="font-semibold text-gray-900">{{ selectedPath.initiative?.title }}</div>
                            <div class="text-sm text-gray-500 mt-1">{{ selectedPath.initiative?.description }}</div>
                        </div>
                    </div>
                </div>

                <!-- Implementation Plan Summary (Clickable) -->
                <div class="p-4 md:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-gray-900">Implementation Plan</h3>
                        <button @click="showImplementationModal = true" class="text-sm text-brand-500 hover:text-brand-600 font-medium">View Full Plan ‚Üí</button>
                    </div>

                    <!-- Compact Phase Overview -->
                    <div class="space-y-2 md:space-y-3">
                        <div v-for="phase in selectedPath.phases" :key="phase.id"
                            @click="openPhaseModal(phase)"
                            class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 md:p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition gap-2 sm:gap-4">
                            <div class="flex flex-wrap items-center gap-2 md:gap-3">
                                <span :class="phaseStatusClass(phase.status)">{{ formatStatus(phase.status) }}</span>
                                <span class="font-medium text-gray-900 text-sm md:text-base">{{ phase.title }}</span>
                                <span class="text-xs md:text-sm text-gray-500">({{ phase.steps?.length || 0 }} steps)</span>
                            </div>
                            <div class="flex items-center gap-3 md:gap-4 text-xs md:text-sm">
                                <span v-if="phase.assignee_name" class="text-gray-500 hidden sm:inline">{{ phase.assignee_name }}</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-16 md:w-20 bg-gray-200 rounded-full h-1.5 md:h-2">
                                        <div class="bg-brand-500 h-1.5 md:h-2 rounded-full" :style="{ width: phase.progress + '%' }"></div>
                                    </div>
                                    <span class="text-gray-600 w-8 md:w-10">{{ phase.progress }}%</span>
                                </div>
                                <span v-if="phase.due_date" class="text-gray-500 hidden md:inline">{{ formatDate(phase.due_date) }}</span>
                                <span class="text-gray-400">‚Ä∫</span>
                            </div>
                        </div>
                        <div v-if="!selectedPath.phases?.length" class="text-center py-8 text-gray-500">No implementation plan yet.</div>
                    </div>
                </div>
            </div>

        </main>
        </div>

        <!-- Implementation Plan Modal -->
        <div v-if="showImplementationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-2 md:p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden flex flex-col">
                <div class="p-4 md:p-6 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-lg md:text-xl font-bold text-gray-900">Implementation Plan</h2>
                    <button @click="showImplementationModal = false" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-4 md:p-6 overflow-y-auto flex-1">
                    <p class="text-gray-600 mb-4 md:mb-6 text-sm md:text-base" v-if="selectedPath.project_summary">{{ selectedPath.project_summary }}</p>

                    <!-- Phases Table - Hidden on mobile -->
                    <table class="w-full hidden md:table">
                        <thead>
                            <tr class="text-left text-sm text-gray-500 border-b border-gray-200">
                                <th class="pb-3 font-medium">Phase</th>
                                <th class="pb-3 font-medium">Description</th>
                                <th class="pb-3 font-medium">Assignee</th>
                                <th class="pb-3 font-medium">Progress</th>
                                <th class="pb-3 font-medium">Due date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="phase in selectedPath.phases" :key="phase.id">
                                <!-- Phase Row -->
                                <tr @click="togglePhaseExpand(phase.id)" class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer">
                                    <td class="py-4">
                                        <div class="flex items-center gap-2">
                                            <span class="text-gray-400">{{ expandedPhases[phase.id] ? '‚ñº' : '‚Ä∫' }}</span>
                                            <span class="text-purple-500">üìã</span>
                                            <span class="font-medium">{{ phase.title }}</span>
                                        </div>
                                    </td>
                                    <td class="py-4 text-sm text-gray-600 max-w-xs">{{ phase.description || 'No description' }}</td>
                                    <td class="py-4">
                                        <div v-if="phase.assignee_name" class="flex items-center gap-2">
                                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-xs font-medium">{{ phase.assignee_name.charAt(0) }}</div>
                                            <span class="text-sm">{{ phase.assignee_name }}</span>
                                        </div>
                                        <span v-else class="text-gray-400 text-sm">‚Äî</span>
                                    </td>
                                    <td class="py-4">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm">{{ phase.progress }}%</span>
                                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                                <div class="bg-indigo-500 h-2 rounded-full" :style="{ width: phase.progress + '%' }"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="py-4 text-sm text-gray-600">
                                        <span v-if="phase.due_date">üìÖ {{ formatDate(phase.due_date) }}</span>
                                        <span v-else class="text-gray-400">‚Äî</span>
                                    </td>
                                </tr>
                                <!-- Steps (when expanded) -->
                                <template v-if="expandedPhases[phase.id]">
                                    <tr v-for="step in phase.steps" :key="step.id" @click.stop="openStepModal(step, phase)" class="border-b border-gray-50 bg-gray-50 hover:bg-gray-100 cursor-pointer">
                                        <td class="py-3 pl-10">
                                            <div class="flex items-center gap-2">
                                                <span class="text-blue-500">üìù</span>
                                                <span class="text-sm">{{ step.title }}</span>
                                            </div>
                                        </td>
                                        <td class="py-3 text-sm text-gray-500">{{ step.description || '' }}</td>
                                        <td class="py-3">
                                            <div v-if="step.assignee_name" class="flex items-center gap-2">
                                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white text-xs">{{ step.assignee_name.charAt(0) }}</div>
                                                <span class="text-sm">{{ step.assignee_name }}</span>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <span class="text-sm text-gray-500">{{ step.progress }}%</span>
                                        </td>
                                        <td class="py-3 text-sm text-gray-500">
                                            <span v-if="step.due_date">{{ formatDate(step.due_date) }}</span>
                                        </td>
                                    </tr>
                                    <!-- Action Items -->
                                    <template v-for="step in phase.steps" :key="'actions-' + step.id">
                                        <tr v-for="item in step.action_items" :key="item.id" @click.stop="openActionModal(item, step, phase)" class="border-b border-gray-50 bg-white hover:bg-gray-100 cursor-pointer">
                                            <td class="py-2 pl-16">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-brand-500">‚ö°</span>
                                                    <span class="text-sm" :class="item.status === 'done' ? 'text-gray-400 line-through' : ''">{{ item.title }}</span>
                                                </div>
                                            </td>
                                            <td class="py-2 text-sm text-gray-400">{{ item.description || '' }}</td>
                                            <td class="py-2">
                                                <div v-if="item.assignee_name" class="flex items-center gap-2">
                                                    <div class="w-5 h-5 rounded-full bg-brand-500 flex items-center justify-center text-white text-xs">{{ item.assignee_name.charAt(0) }}</div>
                                                    <span class="text-xs">{{ item.assignee_name }}</span>
                                                </div>
                                            </td>
                                            <td class="py-2">
                                                <span :class="actionStatusClass(item.status)" class="text-xs">{{ formatStatus(item.status) }}</span>
                                            </td>
                                            <td class="py-2 text-xs text-gray-500">
                                                <span v-if="item.due_date">{{ formatDate(item.due_date) }}</span>
                                            </td>
                                        </tr>
                                    </template>
                                </template>
                            </template>
                        </tbody>
                    </table>

                    <!-- Mobile Card View -->
                    <div class="md:hidden space-y-3">
                        <div v-for="phase in selectedPath.phases" :key="phase.id" class="bg-gray-50 rounded-lg p-3">
                            <div @click="togglePhaseExpand(phase.id)" class="flex items-center justify-between cursor-pointer">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400">{{ expandedPhases[phase.id] ? '‚ñº' : '‚Ä∫' }}</span>
                                    <span class="text-purple-500">üìã</span>
                                    <span class="font-medium text-sm">{{ phase.title }}</span>
                                </div>
                                <span class="text-xs text-gray-500">{{ phase.progress }}%</span>
                            </div>
                            <div v-if="expandedPhases[phase.id]" class="mt-3 space-y-2 pl-6">
                                <div v-for="step in phase.steps" :key="step.id" @click="openStepModal(step, phase)" class="bg-white rounded-lg p-2 cursor-pointer">
                                    <div class="flex items-center gap-2">
                                        <span class="text-blue-500">üìù</span>
                                        <span class="text-xs font-medium">{{ step.title }}</span>
                                    </div>
                                    <div class="flex flex-wrap gap-1 mt-1 pl-5">
                                        <span v-for="item in step.action_items" :key="item.id" :class="['text-xs px-1.5 py-0.5 rounded', item.status === 'done' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600']">
                                            {{ item.title.substring(0, 20) }}{{ item.title.length > 20 ? '...' : '' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase Detail Modal -->
        <div v-if="selectedPhase" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-2 md:p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] md:max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="p-4 md:p-5 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center gap-3 min-w-0">
                        <span class="text-purple-500 text-xl">üìã</span>
                        <h2 class="text-lg md:text-xl font-bold text-gray-900 truncate">{{ selectedPhase.title }}</h2>
                        <button class="text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><circle cx="4" cy="10" r="2"/><circle cx="10" cy="10" r="2"/><circle cx="16" cy="10" r="2"/></svg>
                        </button>
                    </div>
                    <button @click="selectedPhase = null" class="text-gray-400 hover:text-gray-600 text-2xl flex-shrink-0">&times;</button>
                </div>

                <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                    <!-- Left Column - Main Content -->
                    <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                        <!-- Description -->
                        <div class="mb-5">
                            <div class="flex items-center gap-2 text-gray-500 mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                                </svg>
                                <span class="text-sm font-medium">Description</span>
                            </div>
                            <p v-if="selectedPhase.description" class="text-gray-700 text-sm leading-relaxed">{{ selectedPhase.description }}</p>
                            <p v-else class="text-gray-400 text-sm italic">No description provided</p>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mb-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Progress</span>
                                <span class="text-sm font-bold text-gray-900">{{ selectedPhase.progress }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full transition-all" :class="selectedPhase.progress >= 80 ? 'bg-green-500' : selectedPhase.progress >= 50 ? 'bg-blue-500' : 'bg-red-400'" :style="{ width: selectedPhase.progress + '%' }"></div>
                            </div>
                        </div>

                        <!-- Timeline & Workload -->
                        <div class="flex flex-wrap gap-x-8 gap-y-2 mb-5 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-blue-500 font-medium">Due date</span>
                                <span class="text-gray-900">{{ selectedPhase.due_date ? formatDateLong(selectedPhase.due_date) : '‚Äî' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 font-medium">Workload</span>
                                <span class="text-gray-900">{{ selectedPhase.workload_days ? selectedPhase.workload_days + ' days of work' : '‚Äî' }}</span>
                            </div>
                        </div>

                        <!-- Metadata Row -->
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-3 mb-6 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Assignee</span>
                                <div v-if="selectedPhase.assignee_name" class="flex items-center gap-2">
                                    <div class="w-7 h-7 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-xs font-medium">{{ selectedPhase.assignee_name.charAt(0) }}</div>
                                    <span class="font-medium text-gray-900">{{ selectedPhase.assignee_name }}</span>
                                </div>
                                <span v-else class="text-gray-400">‚Äî</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Priority</span>
                                <span v-if="selectedPhase.priority" :class="priorityBadgeClass(selectedPhase.priority)">
                                    <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    Priority {{ selectedPhase.priority === 'critical' ? '1' : selectedPhase.priority === 'high' ? '2' : selectedPhase.priority === 'medium' ? '3' : '4' }}
                                </span>
                                <span v-else class="text-gray-400">‚Äî</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Status</span>
                                <span :class="statusRiskBadgeClass(selectedPhase.status)">{{ formatStatusRisk(selectedPhase.status) }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Category</span>
                                <span v-if="selectedPhase.category" class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-medium">{{ selectedPhase.category }}</span>
                                <span v-else class="text-gray-400">‚Äî</span>
                            </div>
                        </div>

                        <!-- Steps Section -->
                        <div class="border-t border-gray-100 pt-5">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-purple-500" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    <span class="font-semibold text-gray-900">Steps</span>
                                    <span class="text-sm text-gray-500">{{ selectedPhase.steps_completed || 0 }}/{{ selectedPhase.steps?.length || 0 }} completed</span>
                                </div>
                                <button class="flex items-center gap-1 px-3 py-1.5 border border-gray-200 rounded-lg text-sm text-gray-600 hover:bg-gray-50">
                                    <span>+</span> Add task
                                </button>
                            </div>

                            <!-- Steps Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div v-for="(step, index) in selectedPhase.steps" :key="step.id"
                                    @click="openStepModal(step, selectedPhase)"
                                    class="p-4 bg-white border border-gray-200 rounded-xl hover:border-gray-300 hover:shadow-sm cursor-pointer transition">
                                    <div class="flex items-start gap-3">
                                        <div :class="['w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5', step.status === 'done' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300']">
                                            <svg v-if="step.status === 'done'" class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 class="font-medium text-gray-900 text-sm">{{ selectedPhase.order }}.{{ index + 1 }}. {{ step.title }}</h4>
                                            <div class="flex flex-wrap items-center gap-2 mt-2">
                                                <span :class="statusRiskBadgeClass(step.status)" class="text-xs">{{ formatStatusRisk(step.status) }}</span>
                                                <span v-if="step.due_date" class="flex items-center gap-1 text-xs text-gray-500">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                                    {{ formatDate(step.due_date) }}
                                                </span>
                                                <div v-if="step.assignee_name" class="w-6 h-6 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white text-xs ml-auto">{{ step.assignee_name.charAt(0) }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="!selectedPhase.steps?.length" class="text-center py-8 text-gray-500 text-sm">No steps defined yet.</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Step Detail Modal -->
        <div v-if="selectedStep" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-2 md:p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] md:max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="p-4 md:p-5 border-b border-gray-100 flex items-center justify-between">
                    <div class="flex items-center gap-3 min-w-0">
                        <span class="text-blue-500 text-xl">üìù</span>
                        <div class="min-w-0">
                            <h2 class="text-lg md:text-xl font-bold text-gray-900 truncate">{{ selectedStep.title }}</h2>
                            <p class="text-sm text-gray-500 flex items-center gap-1">
                                <span>Phase</span>
                                <span class="text-purple-500">üìã</span>
                                <span>{{ selectedStepParentPhase?.title }}</span>
                            </p>
                        </div>
                        <button class="text-gray-400 hover:text-gray-600 ml-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><circle cx="4" cy="10" r="2"/><circle cx="10" cy="10" r="2"/><circle cx="16" cy="10" r="2"/></svg>
                        </button>
                    </div>
                    <button @click="selectedStep = null" class="text-gray-400 hover:text-gray-600 text-2xl flex-shrink-0">&times;</button>
                </div>

                <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                    <!-- Left Column - Main Content -->
                    <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                        <!-- Description -->
                        <div class="mb-5">
                            <div class="flex items-center gap-2 text-gray-500 mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
                                </svg>
                                <span class="text-sm font-medium">Description</span>
                            </div>
                            <p v-if="selectedStep.description" class="text-gray-700 text-sm leading-relaxed">{{ selectedStep.description }}</p>
                            <p v-else class="text-gray-400 text-sm italic">No description provided</p>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mb-5">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Progress</span>
                                <span class="text-sm font-bold text-gray-900">{{ selectedStep.progress }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full transition-all" :class="selectedStep.progress >= 80 ? 'bg-green-500' : selectedStep.progress >= 50 ? 'bg-blue-500' : 'bg-red-400'" :style="{ width: selectedStep.progress + '%' }"></div>
                            </div>
                        </div>

                        <!-- Timeline & Workload -->
                        <div class="flex flex-wrap gap-x-8 gap-y-2 mb-5 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-blue-500 font-medium">Timeline</span>
                                <span class="text-gray-900">{{ selectedStep.due_date ? formatDateLong(selectedStep.due_date) : '‚Äî' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 font-medium">Workload</span>
                                <span class="text-gray-900">{{ selectedStep.workload_days ? selectedStep.workload_days + ' days of work' : '‚Äî' }}</span>
                            </div>
                        </div>

                        <!-- Metadata Row -->
                        <div class="flex flex-wrap items-center gap-x-6 gap-y-3 mb-6 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Assignee</span>
                                <div v-if="selectedStep.assignee_name" class="flex items-center gap-2">
                                    <div class="w-7 h-7 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white text-xs font-medium">{{ selectedStep.assignee_name.charAt(0) }}</div>
                                    <span class="font-medium text-gray-900">{{ selectedStep.assignee_name }}</span>
                                </div>
                                <span v-else class="text-gray-400">‚Äî</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Priority</span>
                                <span v-if="selectedStep.priority" :class="priorityBadgeClass(selectedStep.priority)">
                                    <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/></svg>
                                    Priority {{ selectedStep.priority === 'critical' ? '1' : selectedStep.priority === 'high' ? '2' : selectedStep.priority === 'medium' ? '3' : '4' }}
                                </span>
                                <span v-else class="text-gray-400">‚Äî</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Status</span>
                                <span :class="statusRiskBadgeClass(selectedStep.status)">{{ formatStatusRisk(selectedStep.status) }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500">Category</span>
                                <span v-if="selectedStep.category" class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-medium">{{ selectedStep.category }}</span>
                                <span v-else class="text-gray-400">‚Äî</span>
                            </div>
                        </div>

                        <!-- Action Items Section -->
                        <div class="border-t border-gray-100 pt-5">
                            <div class="flex items-center gap-2 mb-4">
                                <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                <span class="font-semibold text-gray-900">Action items</span>
                                <span class="text-sm text-gray-500">{{ selectedStep.action_items_completed || countCompletedActions(selectedStep) }}/{{ selectedStep.action_items?.length || 0 }} completed</span>
                            </div>

                            <!-- Action Items Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div v-for="item in selectedStep.action_items" :key="item.id"
                                    @click="openActionModal(item, selectedStep, selectedStepParentPhase)"
                                    class="p-4 bg-white border border-gray-200 rounded-xl hover:border-gray-300 hover:shadow-sm cursor-pointer transition">
                                    <div class="flex items-start gap-3">
                                        <div :class="['w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5', item.status === 'done' ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300']">
                                            <svg v-if="item.status === 'done'" class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h4 :class="['font-medium text-sm', item.status === 'done' ? 'text-gray-400 line-through' : 'text-gray-900']">{{ item.title }}</h4>
                                            <div class="flex flex-wrap items-center gap-2 mt-2">
                                                <span :class="actionItemStatusBadgeClass(item)" class="text-xs">{{ formatActionItemStatus(item) }}</span>
                                                <span v-if="item.due_date" class="flex items-center gap-1 text-xs text-gray-500">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                                    {{ formatDate(item.due_date) }}
                                                </span>
                                                <div v-if="item.assignee_name" class="w-6 h-6 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center text-white text-xs ml-auto">{{ item.assignee_name.charAt(0) }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="!selectedStep.action_items?.length" class="text-center py-8 text-gray-500 text-sm">No action items in this step.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Item Detail Modal -->
        <div v-if="selectedAction" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-2 md:p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[95vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="p-4 md:p-6 border-b border-gray-100 flex items-center justify-between">
                    <h2 class="text-lg md:text-xl font-bold text-gray-900">{{ selectedAction.title }}</h2>
                    <button @click="selectedAction = null" class="text-gray-400 hover:text-gray-600 text-2xl flex-shrink-0">&times;</button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto">
                    <div class="flex flex-col md:flex-row">
                        <!-- Main Content -->
                        <div class="flex-1 p-4 md:p-6">
                            <!-- Breadcrumb: Phase > Step -->
                            <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
                                <span class="text-brand-500">üìÅ</span>
                                <span>{{ selectedActionParentPhase?.title }}</span>
                                <span>&gt;</span>
                                <span>{{ selectedActionParentStep?.title }}</span>
                            </div>

                            <!-- Description -->
                            <div class="mb-6">
                                <h3 class="text-sm font-semibold text-gray-900 mb-2">Description</h3>
                                <div v-if="selectedAction.description" class="text-gray-600 text-sm leading-relaxed">
                                    <p>{{ selectedAction.description }}</p>
                                </div>
                                <p v-else class="text-gray-400 text-sm italic">No description provided.</p>
                            </div>

                            <!-- Notes -->
                            <div v-if="selectedAction.notes">
                                <h3 class="text-sm font-semibold text-gray-900 mb-2">Notes</h3>
                                <p class="text-gray-600 text-sm leading-relaxed">{{ selectedAction.notes }}</p>
                            </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="w-full md:w-64 border-t md:border-t-0 md:border-l border-gray-100 p-4 md:p-6 bg-gray-50">
                            <!-- Assignee -->
                            <div class="mb-5">
                                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Assignee</label>
                                <div class="mt-2 flex items-center gap-2">
                                    <div v-if="selectedAction.assignee_name" class="w-7 h-7 rounded-full bg-brand-500 flex items-center justify-center text-white text-xs font-medium">
                                        {{ selectedAction.assignee_name.charAt(0) }}
                                    </div>
                                    <div v-else class="w-7 h-7 rounded-full bg-gray-200 flex items-center justify-center">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                    <span class="text-sm text-gray-900">{{ selectedAction.assignee_name || 'Unassigned' }}</span>
                                </div>
                            </div>

                            <!-- Status -->
                            <div class="mb-5">
                                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Status</label>
                                <div class="mt-2">
                                    <span :class="actionItemStatusBadgeClass(selectedAction.status)">{{ formatActionItemStatus(selectedAction.status) }}</span>
                                </div>
                            </div>

                            <!-- Timeline -->
                            <div class="mb-5">
                                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Timeline</label>
                                <div class="mt-2 space-y-1">
                                    <div v-if="selectedAction.due_date" class="flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        <span class="text-gray-900">Due: {{ formatDate(selectedAction.due_date) }}</span>
                                    </div>
                                    <div v-if="selectedAction.completed_at" class="flex items-center gap-2 text-sm">
                                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span class="text-gray-900">Completed: {{ formatDate(selectedAction.completed_at) }}</span>
                                    </div>
                                    <p v-if="!selectedAction.due_date && !selectedAction.completed_at" class="text-sm text-gray-400">No dates set</p>
                                </div>
                            </div>

                            <!-- Created/Updated -->
                            <div>
                                <label class="text-xs font-medium text-gray-500 uppercase tracking-wide">Activity</label>
                                <div class="mt-2 space-y-1 text-xs text-gray-500">
                                    <p v-if="selectedAction.created_at">Created: {{ formatDate(selectedAction.created_at) }}</p>
                                    <p v-if="selectedAction.updated_at">Updated: {{ formatDate(selectedAction.updated_at) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endverbatim %}

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    paths: [],
                    selectedPath: null,
                    currentFilter: 'all',
                    searchQuery: '',
                    searchTimeout: null,
                    summaryExpanded: true,
                    showImplementationModal: false,
                    expandedPhases: {},
                    selectedPhase: null,
                    selectedStep: null,
                    selectedStepParentPhase: null,
                    selectedAction: null,
                    selectedActionParentStep: null,
                    selectedActionParentPhase: null,
                    filters: [
                        { label: 'All', value: 'all' },
                        { label: 'Active', value: 'active' },
                        { label: 'On Hold', value: 'on_hold' },
                        { label: 'Completed', value: 'completed' },
                    ],
                    API_BASE: '/api',
                    // Mobile
                    mobileMenuOpen: false
                };
            },
            computed: {
                stats() {
                    return {
                        total: this.paths.length,
                        active: this.paths.filter(p => p.status === 'active').length,
                        on_hold: this.paths.filter(p => p.status === 'on_hold').length,
                        completed: this.paths.filter(p => p.status === 'completed').length,
                    };
                },
                filteredPaths() {
                    if (this.currentFilter === 'all') return this.paths;
                    return this.paths.filter(p => p.status === this.currentFilter);
                }
            },
            methods: {
                async fetchPaths() {
                    try {
                        let url = `${this.API_BASE}/paths/`;
                        if (this.searchQuery) url += `?search=${encodeURIComponent(this.searchQuery)}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        this.paths = data.results || data;
                    } catch (err) { console.error('Error:', err); }
                },
                debouncedSearch() {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => this.fetchPaths(), 300);
                },
                clearSearch() { this.searchQuery = ''; this.fetchPaths(); },
                async selectPath(id) {
                    try {
                        const res = await fetch(`${this.API_BASE}/paths/${id}/`);
                        this.selectedPath = await res.json();
                        this.summaryExpanded = true;
                        this.expandedPhases = {};
                    } catch (err) { console.error('Error:', err); }
                },
                async updatePathStatus(status) {
                    try {
                        const res = await fetch(`${this.API_BASE}/paths/${this.selectedPath.id}/update_status/`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status })
                        });
                        this.selectedPath = await res.json();
                        this.fetchPaths();
                    } catch (err) { console.error('Error:', err); }
                },
                togglePhaseExpand(phaseId) {
                    this.expandedPhases[phaseId] = !this.expandedPhases[phaseId];
                },
                openPhaseModal(phase) {
                    this.selectedPhase = phase;
                },
                openStepModal(step, phase) {
                    this.selectedStep = step;
                    this.selectedStepParentPhase = phase;
                },
                openActionModal(action, step, phase) {
                    this.selectedAction = action;
                    this.selectedActionParentStep = step;
                    this.selectedActionParentPhase = phase;
                },
                countPhaseActions(phase) {
                    let count = 0;
                    if (phase.steps) {
                        phase.steps.forEach(s => { count += s.action_items?.length || 0; });
                    }
                    return count;
                },
                formatStatus(status) {
                    const map = { draft: 'Draft', active: 'Active', on_hold: 'On Hold', completed: 'Completed', archived: 'Archived', todo: 'To Do', in_progress: 'In Progress', blocked: 'Blocked', done: 'Done' };
                    return map[status] || status;
                },
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString();
                },
                formatDateLong(dateStr) {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                },
                formatRelativeTime(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    if (diffDays === 0) return 'today';
                    if (diffDays === 1) return 'yesterday';
                    if (diffDays < 7) return `${diffDays} days ago`;
                    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                    if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
                    return `${Math.floor(diffDays / 365)} years ago`;
                },
                statusBadgeClass(status) {
                    const c = {
                        draft: 'bg-gray-100 text-gray-600',
                        active: 'bg-emerald-50 text-emerald-700',
                        on_hold: 'bg-amber-50 text-amber-700',
                        completed: 'bg-teal-50 text-teal-700',
                        archived: 'bg-gray-100 text-gray-500'
                    };
                    return `inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-sm font-medium before:content-['‚Ä¢'] before:text-current ${c[status] || ''}`;
                },
                priorityBadgeClass(priority) {
                    const c = { low: 'bg-gray-100 text-gray-600', medium: 'bg-blue-100 text-blue-600', high: 'bg-amber-100 text-amber-700', critical: 'bg-red-100 text-red-600' };
                    return `px-3 py-1 rounded-full text-xs font-medium ${c[priority] || ''}`;
                },
                phaseStatusClass(status) {
                    const c = { todo: 'bg-gray-200 text-gray-700', in_progress: 'bg-blue-200 text-blue-800', blocked: 'bg-red-200 text-red-800', done: 'bg-green-200 text-green-800' };
                    return `px-2 py-1 rounded text-xs font-semibold ${c[status] || ''}`;
                },
                stepStatusClass(status) {
                    const c = { todo: 'bg-gray-100 text-gray-600', in_progress: 'bg-blue-100 text-blue-700', blocked: 'bg-red-100 text-red-700', done: 'bg-green-100 text-green-700' };
                    return `px-2 py-0.5 rounded text-xs ${c[status] || ''}`;
                },
                actionStatusClass(status) {
                    const c = { todo: 'text-gray-500', in_progress: 'text-blue-600', blocked: 'text-red-600', done: 'text-green-600' };
                    return c[status] || '';
                },
                actionStatusBadgeClass(status) {
                    const c = { todo: 'bg-gray-100 text-gray-600', in_progress: 'bg-blue-100 text-blue-600', blocked: 'bg-red-100 text-red-600', done: 'bg-green-100 text-green-600' };
                    return `px-3 py-1 rounded-full text-xs font-medium ${c[status] || ''}`;
                },
                // Status risk badge for Phase/Step detail modals
                statusRiskBadgeClass(status) {
                    const c = {
                        todo: 'bg-gray-100 text-gray-700',
                        in_progress: 'bg-blue-100 text-blue-700',
                        blocked: 'bg-red-100 text-red-700',
                        done: 'bg-green-100 text-green-700'
                    };
                    return `px-2 py-1 rounded text-xs font-medium ${c[status] || 'bg-gray-100 text-gray-700'}`;
                },
                formatStatusRisk(status) {
                    const map = {
                        todo: 'Not started',
                        in_progress: 'In progress',
                        blocked: 'At Risk',
                        done: 'Done'
                    };
                    return map[status] || status;
                },
                // Action item status for cards
                actionItemStatusBadgeClass(item) {
                    if (item.status === 'done') return 'bg-green-100 text-green-700 px-2 py-0.5 rounded';
                    if (item.status === 'in_progress') return 'bg-blue-100 text-blue-700 px-2 py-0.5 rounded';
                    if (item.status === 'blocked') return 'bg-red-100 text-red-700 px-2 py-0.5 rounded';
                    // Check if overdue
                    if (item.due_date && new Date(item.due_date) < new Date()) {
                        return 'bg-red-100 text-red-700 px-2 py-0.5 rounded';
                    }
                    return 'bg-gray-100 text-gray-700 px-2 py-0.5 rounded';
                },
                formatActionItemStatus(item) {
                    if (item.status === 'done') return 'Done';
                    if (item.status === 'in_progress') return 'In progress';
                    if (item.status === 'blocked') return 'Blocked';
                    // Check if overdue
                    if (item.due_date && new Date(item.due_date) < new Date() && item.status !== 'done') {
                        return 'Overdue';
                    }
                    return 'Not started';
                },
                countCompletedActions(step) {
                    if (!step.action_items) return 0;
                    return step.action_items.filter(i => i.status === 'done').length;
                }
            },
            mounted() { this.fetchPaths(); }
        }).mount('#app');
    </script>
</body>
</html>
